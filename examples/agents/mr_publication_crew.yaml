name: MR Publication Crew
process: sequential
memory: True

agents:
  - role: Publication Agent
    goal: |
      Publish the impact assessment report to the MR, ensuring that all stakeholders are informed of the evaluation results.
      Format the report using Markdown for readability.
    backstory: |
      A diligent communicator who values transparency and clarity.
      Skilled in formatting and presenting information effectively, making sure the assessment is accessible and understandable to all MR participants.
    tools:
      - GitlabMergeCommentTool

  - role: Execution Agent
    goal: |
      Execute the approval and merge actions based on the recommendation from the impact assessment report.
      If the recommendation is to auto-approve and merge, proceed to approve and merge the MR using the GitLab API.
      If the recommendation is for manual review, then do nothing.
    backstory: |
      A responsible executor who follows decisions.
      Prioritizes adherence to established policies and procedures, ensuring that actions are carried out accurately and efficiently.
    tools:
      - GitlabMergeApprovalTool
      - GitlabMergeCommentTool

tasks:
  - description: |
      Receive the impact assessment report and the recommendation from the Impact Evaluator Crew.

      **Tasks**:
      - Format the impact assessment report using Markdown for readability and consistency.
      - Post the formatted report as a comment on the MR, making it available to all stakeholders.

      **Inputs**:
      - **MR ID**: {input}
      - **Impact Assessment Report**:
      {impact_assessment_report}

    agent: Publication Agent
    expected_output: |
      - The impact assessment report is posted on the MR as a comment, properly formatted in Markdown.
      - The comment is visible to all MR participants and stakeholders.
      - Confirmation that the posting was successful, or an error message if it failed.

  - description: |
      Based on the recommendation from the Impact Evaluator Crew, execute the following:

      **If the recommendation is to "Auto-approve and merge"**:
      - Approve the MR using the GitLab API.
      - Post a confirmation comment on the MR indicating that it has been approved.

      **If the recommendation is "Requires human review"**:
      - Leave the MR open for manual review.
      - Post a comment on the MR indicating that it requires further review due to its impact assessment.

      **Inputs**:
      - **MR ID**: {input}
      - **Impact Assessment Report**:
      {impact_assessment_report}
    agent: Execution Agent
    expected_output: |
      - **If auto-approved and merged**:
        - The MR is approved.
        - The MR is merged into the target branch.
        - A confirmation comment is posted on the MR indicating successful approval and merge.
        - Confirmation messages or logs indicating the actions were successful, or error messages if any actions failed.

      - **If not auto-approved**:
        - The MR remains open for manual review.
        - A comment is posted on the MR indicating that the MR requires further review due to its impact assessment.
